<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<title>J2me Simulator</title>
</head>

<body>
<a href="https://github.com/shifat100/j2me" data-allowlist="true">Github Repository</a>

	<div class="container">
		
		<div class="panel device">
			<div class="header" style="display:none">
				<div class="headersection left">
					<div class="headeritem mode">‚ôª</div>
				</div>
				<div class="headersection right">
					<div class="headeritem">üì∂</div>
					<div class="headeritem clock"></div>
				</div>
			</div>
			<div class="glass">
				<div class="keyselector">
					<div>2</div>
					<div class="selected">a</div>
					<div>b</div>
					<div>c</div>
				</div>
			</div>
			<iframe id="appFrame" src="./index.html?cloudfone=true" scrolling="no"></iframe>
			<div class="brand"></div>
			<table class="keypad">
				<tr>
					<td>
						<div class="button sk largeicon" data-key="SoftLeft">‚Äî</div>
					</td>
					<td>
						<div class="button sk" data-key="ArrowUp">‚Üë</div>
					</td>
					<td>
						<div class="button sk largeicon" data-key="SoftRight">‚Äî</div>
					</td>
				</tr>
				<tr>
					<td>
						<div class="button lr" data-key="ArrowLeft">‚Üê</div>
					</td>
					<td>
						<div class="button sk" data-key="Enter">Enter</div>
					</td>
					<td>
						<div class="button lr" data-key="ArrowRight">‚Üí</div>
					</td>
				</tr>
				<tr>
					<td>
						<div class="button largeicon call" data-key="Call">‚Äî</div> <!-- Assuming Call key might be useful -->
					</td>
					<td>
						<div class="button sk" data-key="ArrowDown">‚Üì</div>
					</td>
					<td>
						<div class="button largeicon backspace" data-key="Backspace">‚Äî</div>
					</td>
				</tr>
				<tr>
					<td>
						<div class="button char" data-key="1">1 <span>.,?</span></div>
					</td>
					<td>
						<div class="button char" data-key="2">2 <span>ABC</span></div>
					</td>
					<td>
						<div class="button char" data-key="3">3 <span>DEF</span></div>
					</td>
				</tr>
				<tr>
					<td>
						<div class="button char" data-key="4">4 <span>GHI</span></div>
					</td>
					<td>
						<div class="button char" data-key="5">5 <span>JKL</span></div>
					</td>
					<td>
						<div class="button char" data-key="6">6 <span>MNO</span></div>
					</td>
				</tr>
				<tr>
					<td>
						<div class="button char" data-key="7">7 <span>PQRS</span></div>
					</td>
					<td>
						<div class="button char" data-key="8">8 <span>TUV</span></div>
					</td>
					<td>
						<div class="button char" data-key="9">9 <span>WXYZ</span></div>
					</td>
				</tr>
				<tr>
					<td>
						<div class="button char specialchars largeicon" data-key="*">‚àó</div> <!-- Added char class -->
					</td>
					<td>
						<div class="button char" data-key="0">0 _</div>
					</td>
					<td>
						<div class="button mode" data-key="#"># <span>‚á™</span></div>
					</td>
				</tr>
			</table>
		</div>
		<div class="panel controlpanel">
			<h3>Configuration</h3>
			<div id="online-toggle-container">
				<input type="checkbox" id="online-checkbox" name="online" checked autocomplete="off" />
				<label for="online-checkbox">Online/offline</label>
			</div>
			<div id="experiment-trending-container">
				<input type="checkbox" id="experiment-trending-checkbox" name="experiment-trending" autocomplete="off" />
				<label for="experiment-trending-checkbox">Experiment Group (Trending articles)</label>
			</div>
			
			<!-- *** NEW: Custom User Agent Controls *** -->
			<div id="user-agent-container" style="display:none">
				<label for="user-agent-input">Custom User Agent:</label>
				<input type="text" id="user-agent-input" placeholder="Enter custom user agent...">
				<button id="user-agent-apply-btn">Apply & Reload</button>
			</div>
			<!-- *** END NEW *** -->

		</div>
		<style type="text/css">
			.container {
				display: flex;
				flex-wrap: wrap;
			}

			.panel {
				margin: 20px;
				width: 260px;
				box-sizing: border-box;
			}

			.device {
				width: 260px;
				padding: 20px 10px;
				border-radius: 20px;
				background-color: grey;
				position: relative;
				box-sizing: border-box;
			}

			.header {
				display: flex;
				justify-content: space-between;
				height: 20px;
				background-color: #ccc;
			}

			.headersection.left {
				display: flex;
				justify-content: flex-start;
			}

			.headersection.right {
				display: flex;
				justify-content: flex-end;
			}

			.headeritem {
				font-size: 14px;
				font-family: sans-serif;
				align-self: center;
				margin: 0;
				padding: 4px;
			}

			.glass {
				position: absolute;
				top: 40px;
				left: 10px;
				width: 240px;
				height: 290px;
				cursor: not-allowed;
			}

			.keyselector {
				display: flex;
				position: absolute;
				bottom: 0;
				left: 0;
				height: 30px;
				width: 100%;
				background-color: #ccc;
			}

			.keyselector div {
				width: 30px;
				height: 30px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.keyselector div.selected {
				background-color: blue;
				color: white;
			}

			#appFrame {
				width: 240px;
				height: 320px;
				border: 0;
			}

			.brand {
				padding: 10px 10px 6px 38px;
				letter-spacing: 20px;
				text-align: center;
				color: white;
				font-weight: bold;
				font-family: sans-serif;
			}

			.keypad {
				width: 100%;
			}

			.button {
				color: white;
				background-color: black;
				font-weight: bold;
				text-align: center;
				padding: 5px;
				border-radius: 20px;
				font-size: 12px;
				line-height: 12.5px;
				font-family: sans-serif;
				cursor: pointer;
			}

			.button.largeicon {
				font-size: 26px;
			}

			.button.call {
				color: green;
			}

			.button.backspace {
				color: red;
			}

			.button span {
				font-size: 8px;
			}
			
			/* *** NEW: Styling for Custom User Agent Controls *** */
			#user-agent-container {
				margin-top: 15px;
				padding-top: 10px;
				border-top: 1px solid #ccc;
			}
			#user-agent-container label {
				display: block;
				margin-bottom: 5px;
			}
			#user-agent-input {
				width: 100%;
				padding: 5px;
				box-sizing: border-box;
				margin-bottom: 5px;
			}
			#user-agent-apply-btn {
				width: 100%;
				padding: 8px;
				cursor: pointer;
			}
			/* *** END NEW *** */
		</style>
		<script type="text/javascript">
			// *** NEW: Global variable for custom user agent ***
			let customUserAgent = 'Mozilla/5.0 (Cloud Phone 2.3; Snexian GURU 4G; ASR) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.6613.170 Mobile Safari/537.36 Puffin/128.4.5.68109FP';

			const keysMap = {
				'1': ['.', ',', '?', '!', '1', ';', ':', '/', '@'],
				'2': ['a', 'b', 'c', '2'],
				'3': ['d', 'e', 'f', '3'],
				'4': ['g', 'h', 'i', '4'],
				'5': ['j', 'k', 'l', '5'],
				'6': ['m', 'n', 'o', '6'],
				'7': ['p', 'q', 'r', 's', '7'],
				'8': ['t', 'u', 'v', '8'],
				'9': ['w', 'x', 'y', 'z', '9'],
				'0': [' ', '0'],
				'*': ['*']
			};
			const inputModes = [
				{ name: 'lowercase', text: 'Ôî°', fn: function (key, keys) { return keys ? keys.map(k => k.toLowerCase()) : [key.toLowerCase()]; } },
				{ name: 'uppercase', text: 'Ôî†', fn: function (key, keys) { return keys ? keys.map(k => k.toUpperCase()) : [key.toUpperCase()]; } },
				{ name: 'number', text: 'Ôî¢', fn: function (key) { return [key]; } }
			];
			var currentInputMode = 0;
			const inputModeIndicator = document.querySelector('.headeritem.mode');
			const nextInputMode = function () {
				currentInputMode = (currentInputMode === inputModes.length - 1 ? 0 : currentInputMode + 1);
				inputModeIndicator.innerHTML = inputModes[currentInputMode].text;
			}
			const keysInCurrentMode = function (key) {
                const baseKeys = keysMap[key] || [key];
				return inputModes[currentInputMode].fn(key, baseKeys);
			}

			const appFrame = document.querySelector('#appFrame');

			const keySelector = (function ($element) {
				$element.style.visibility = 'hidden';
				var keys = [];
				var currentKey = null;
				var timeout = null;
				var lastInputElement;

				const close = function () {
					if (lastInputElement) {
						lastInputElement.dispatchEvent(new InputEvent('input'))
					}
					$element.style.visibility = 'hidden';
				}

				const isClosed = function () {
					return $element.style.visibility === 'hidden';
				};

				const open = function () {
					$element.style.visibility = 'visible';
					clearTimeout(timeout);
					timeout = setTimeout(close, 1000);
				};

				const render = function () {
					$element.innerHTML = '';
					keys.forEach(function (k) {
						const div = document.createElement('div');
						if (k === currentKey) {
							div.classList.add('selected')
						}
						div.appendChild(document.createTextNode(k));
						$element.appendChild(div);
					})
				};

				const arraysEqual = function (a, b) {
					if (!a || !b || a.length !== b.length) {
						return false;
					}
					for (var i = 0; i < a.length; i++) {
						if (a[i] != b[i]) {
							return false;
						}
					}
					return true;
				}

				return function (newKeys, inputElement) {
					var replace;
					lastInputElement = inputElement

					if (isClosed()) {
						keys = newKeys;
						currentKey = newKeys[0];
						replace = false;
					} else if (!arraysEqual(keys, newKeys)) {
						keys = newKeys;
						currentKey = newKeys[0];
						replace = false;
					} else {
						var index = keys.indexOf(currentKey) + 1;
						if (index >= keys.length) {
							index = 0;
						}
						currentKey = keys[index];
						replace = true;
					}
					render();
					open();
					return [currentKey, replace];
				};
			})(document.querySelector('.keyselector'));

			const dispatchKeyToDoc = function (key) {
				const newEvent = new KeyboardEvent('keydown', {
					key: key,
					composed: true,
					bubbles: true,
					cancelable: false
				});
				appFrame.contentDocument.dispatchEvent(newEvent);
			}

			const isInput = function ($element) {
				return $element && ($element.tagName === 'INPUT' || $element.tagName === 'TEXTAREA');
			}

			const keyHandlers = {
				'.button.sk': function (e) {
					dispatchKeyToDoc(e.currentTarget.getAttribute('data-key'));
				},
				'.button.call': function(e) {
					dispatchKeyToDoc(e.currentTarget.getAttribute('data-key'));
				},
				'.button.backspace': function (e) {
					const element = appFrame.contentDocument.activeElement;
					if (isInput(element)) {
						if (element.value !== '' && element.selectionStart > 0) {
							const v = element.value;
							const caretStart = element.selectionStart;
                            const caretEnd = element.selectionEnd;
                            let newCaretPos;
                            if (caretStart === caretEnd) {
							    element.value = v.substring(0, caretStart - 1) + v.substring(caretStart);
                                newCaretPos = caretStart - 1;
                            } else {
                                element.value = v.substring(0, caretStart) + v.substring(caretEnd);
                                newCaretPos = caretStart;
                            }
							element.setSelectionRange(newCaretPos, newCaretPos);
							element.dispatchEvent(new InputEvent('input'));
						}
					} else {
						dispatchKeyToDoc('Backspace');
					}
				},
				'.button.lr': function (e) {
					const element = appFrame.contentDocument.activeElement;
					const key = e.currentTarget.getAttribute('data-key');
					if (isInput(element)) {
						if (key === 'ArrowRight') {
							if (element.selectionEnd < element.value.length) {
								const caret = element.selectionStart + 1;
								element.setSelectionRange(caret, caret);
							}
						} else if (key === 'ArrowLeft') {
							if (element.selectionStart > 0) {
								const caret = element.selectionStart - 1;
								element.setSelectionRange(caret, caret);
							}
						}
					} else {
						dispatchKeyToDoc(key);
					}
				},
				'.button.char': function (e) {
					const dataKey = e.currentTarget.getAttribute('data-key');
					const keys = keysInCurrentMode(dataKey);
					
					const element = appFrame.contentDocument.activeElement;
					if (isInput(element)) {
                        const isNumMode = inputModes[currentInputMode].name === 'number';
                        const hasMultipleCharsForKey = keysMap[dataKey] && keysMap[dataKey].length > 1;
                        const effectiveUseKeySelector = !isNumMode && hasMultipleCharsForKey;


						const [charToInsert, replace] = effectiveUseKeySelector ? keySelector(keys, element) : [keys[0], false];
						
						var val = element.value;
						const currentSelectionStart = element.selectionStart;
						const currentSelectionEnd = element.selectionEnd;
						var newCaretPos;

						if (replace) {
							val = val.substring(0, currentSelectionStart - 1) + charToInsert + val.substring(currentSelectionStart);
							newCaretPos = currentSelectionStart; 
						} else {
							val = val.substring(0, currentSelectionStart) + charToInsert + val.substring(currentSelectionEnd);
							newCaretPos = currentSelectionStart + charToInsert.length;
						}
						element.value = val;
						element.setSelectionRange(newCaretPos, newCaretPos);
						element.dispatchEvent(new InputEvent('input', { data: charToInsert, isComposing: effectiveUseKeySelector }));
					} else {
						dispatchKeyToDoc(keys[0]);
					}
				},
				'.button.mode': nextInputMode
			};
			Object.keys(keyHandlers).forEach(function (selector) {
				Array.from(document.querySelectorAll(selector)).forEach(function (b) {
					b.addEventListener('click', keyHandlers[selector]);
				});
			});

			['keypress', 'keydown', 'keyup', 'mousedown', 'mouseup', 'click'].forEach(function (k) {
				window.addEventListener(k, function (e) {
					if (!e.target.getAttribute('data-allowlist') && !e.target.closest('.controlpanel')) {
						e.preventDefault();
					}
				}, true);
			});

			// Clock
			const pad = function (number) {
				return (number < 10 ? '0' : '') + number;
			}
			const clock = document.querySelector('.headeritem.clock');
			const updateClock = function () {
				const d = new Date();
				clock.innerText = d.getHours() + ':' + pad(d.getMinutes());
			}
			updateClock()
			setInterval(updateClock, 60 * 1000);

			// Online/offline toggle
			const onlineCheckbox = document.querySelector('#online-checkbox');
			onlineCheckbox.addEventListener('change', function (e) {
				const isOnline = e.target.checked;
				Object.defineProperty(appFrame.contentWindow.navigator, "onLine", {
					enumerable: true,
					configurable: true,
					get: function () {
						return isOnline;
					}
				});
				appFrame.contentWindow.dispatchEvent(new Event(isOnline ? 'online' : 'offline'));
			});
            onlineCheckbox.dispatchEvent(new Event('change'));

			// Experiment Group for Trending Articles toggle
			const experimentCheckbox = document.querySelector('#experiment-trending-checkbox');
			experimentCheckbox.addEventListener('change', function (e) {
				const isExperimentEnabled = e.target.checked;
				if (isExperimentEnabled) {
					localStorage.setItem('2021-KaiOS-app-engagement-config', `{"timestamp":${Date.now()},"startDate":"20210101","endDate":"20211231","countries":["NG"],"languages":["en"]}`);
					localStorage.setItem('2021-KaiOS-app-homepage-content-suggestions', 'trending-articles');
					localStorage.setItem('user-country', 'NG');
				} else {
					localStorage.setItem('2021-KaiOS-app-homepage-content-suggestions', 'control');
				}
                appFrame.src = './';
			});

			// *** NEW: Function to apply the custom user agent ***
			function applyCustomUserAgent() {
				// Ensure the iframe's navigator object exists
				if (appFrame && appFrame.contentWindow && appFrame.contentWindow.navigator) {
					// Only apply if a customUserAgent is set
					if (customUserAgent) {
						Object.defineProperty(appFrame.contentWindow.navigator, 'userAgent', {
							get: function () {
								return customUserAgent;
							},
							enumerable: true,
							configurable: true // Important to allow re-defining
						});
						console.log('Applied custom User Agent to iframe:', customUserAgent);
					}
				}
			}

			// *** NEW: Event listener for the Apply button ***
			const userAgentInput = document.querySelector('#user-agent-input');
			const userAgentApplyBtn = document.querySelector('#user-agent-apply-btn');
			userAgentApplyBtn.addEventListener('click', function() {
				const newUA = userAgentInput.value.trim();
				// Set to the new value, or null if the input is empty (to revert to default)
				customUserAgent = newUA ? newUA : null;
				// Reload the iframe to ensure the UA is applied from the very start of page load
				console.log('Reloading iframe with new User Agent configuration...');
				appFrame.src = './index.html?cloudfone=true';
			});


            appFrame.addEventListener('load', function() {
                if (appFrame.contentWindow && appFrame.contentWindow.navigator && !appFrame.contentWindow.navigator.sendBeacon) {
                    appFrame.contentWindow.navigator.sendBeacon = function () { /* no-op */ };
                }
                // Set initial online state after iframe loads
                onlineCheckbox.dispatchEvent(new Event('change'));

				// *** NEW: Apply the custom user agent every time the iframe loads ***
				applyCustomUserAgent();
            });

			// -------------------- DUMMY IMPLEMENTATION START --------------------
			// (The lengthy dummy DeviceStorage mock is unchanged and remains below)
			// ...
			const DUMMY_STORAGE_DATA = {
				pictures: [
					{ name: "holidays/beach.jpg", lastModifiedDate: new Date("2023-01-15T10:00:00Z"), type: "image/jpeg", size: 1024*500 },
					{ name: "pets/cat.png", lastModifiedDate: new Date("2023-03-22T15:30:00Z"), type: "image/png", size: 1024*200 },
					{ name: "food/sushi.gif", lastModifiedDate: new Date("2024-05-01T09:15:00Z"), type: "image/gif", size: 1024*800 },
					{ name: "holidays/mountains.jpg", lastModifiedDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), type: "image/jpeg", size: 1024*600 },
					{ name: "screenshots/error_log.png", lastModifiedDate: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000), type: "image/png", size: 1024*50 }
				],
				music: [ { name: "song1.mp3", lastModifiedDate: new Date(), type: "audio/mpeg", size: 1024*3000 }, ],
				sdcard: [ { name: "my-file.txt", lastModifiedDate: new Date(), type: "text/plain", size: 20 } ]
			};
			if (typeof navigator === 'undefined') { global.navigator = {}; }
			function MockDeviceStorage(storageName) {
				this.storageName = storageName;
				this.data = DUMMY_STORAGE_DATA[storageName] || [];
				this.enumerate = function(pathPrefixOrOptions, optionsOnly) {
					let pathPrefix = null; let options = {};
					if (typeof pathPrefixOrOptions === 'string') { pathPrefix = pathPrefixOrOptions; if (typeof optionsOnly === 'object' && optionsOnly !== null) { options = optionsOnly; }
					} else if (typeof pathPrefixOrOptions === 'object' && pathPrefixOrOptions !== null) { options = pathPrefixOrOptions; }
					return new MockDOMCursor(this.data, pathPrefix, options.since);
				};
				this.get = function(fileName) {
					const request = new MockDOMRequest();
					setTimeout(() => {
						const file = this.data.find(f => f.name === fileName);
						if (file) { request.result = file; if (request.onsuccess) request.onsuccess();
						} else { request.error = new Error("File not found"); if (request.onerror) request.onerror(); }
					}, 50);
					return request;
				};
			}
			function MockDOMCursor(allFiles, pathPrefix, sinceDate) {
				this.files = allFiles.filter(file => { let match = true; if (pathPrefix && !file.name.startsWith(pathPrefix)) { match = false; } if (sinceDate && file.lastModifiedDate < sinceDate) { match = false; } return match; });
				this.currentIndex = -1; this.result = null; this.done = false; this.onsuccess = null; this.onerror = null;
				this._advance = function() { this.currentIndex++; if (this.currentIndex < this.files.length) { this.result = this.files[this.currentIndex]; this.done = false; } else { this.result = null; this.done = true; } };
				this.continue = function() { if (this.done) { if (typeof this.onsuccess === 'function') { this.result = null;  this.done = true; setTimeout(() => this.onsuccess(), 0); } return; } this._advance(); if (typeof this.onsuccess === 'function') { setTimeout(() => this.onsuccess(), 0); } };
				setTimeout(() => { this._advance(); if (typeof this.onsuccess === 'function') { this.onsuccess(); } }, 0);
			}
			function MockDOMRequest() { this.result = null; this.error = null; this.onsuccess = null; this.onerror = null; }
			navigator.getDeviceStorage = function(storageName) { if (DUMMY_STORAGE_DATA[storageName]) { return new MockDeviceStorage(storageName); } return new MockDeviceStorage("__empty__"); };
			navigator.getDeviceStorages = function(storageName) { if (DUMMY_STORAGE_DATA[storageName]) { return [new MockDeviceStorage(storageName)]; } return [new MockDeviceStorage("__empty__")]; };
		</script>
	</div>
</body>

</html>